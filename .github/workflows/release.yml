name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release/publish (e.g. v0.5.0)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: i18next-turbo-linux-x64-gnu
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact: i18next-turbo-linux-x64-musl
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: i18next-turbo-darwin-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: i18next-turbo-darwin-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: i18next-turbo-win32-x64-msvc
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref }}
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: release-${{ matrix.target }}
      - name: Install musl toolchain
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools musl-dev
      - name: Build
        run: cargo build --release --target ${{ matrix.target }}
      - name: Package binary (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          ./scripts/package-binary.sh "${{ matrix.target }}" "${{ matrix.artifact }}" "i18next-turbo"
      - name: Package binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          ./scripts/package-binary.ps1 -Target "${{ matrix.target }}" -Artifact "${{ matrix.artifact }}" -BinaryName "i18next-turbo.exe"
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/*

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref }}
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Create or update GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
        run: |
          mapfile -t release_assets < <(find dist -type f \( -name '*.tar.gz' -o -name '*.zip' \) | sort)
          if [ ${#release_assets[@]} -eq 0 ]; then
            echo "No release archive assets found under dist/"
            exit 1
          fi

          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            gh release upload "$TAG_NAME" "${release_assets[@]}" --clobber
          else
            gh release create "$TAG_NAME" "${release_assets[@]}" --generate-notes
          fi

  publish-platform-npm:
    runs-on: ubuntu-latest
    needs: [build, release]
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
    continue-on-error: ${{ matrix.allow_failure || false }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - artifact: i18next-turbo-darwin-x64
            package_name: i18next-turbo-darwin-x64
            os: darwin
            cpu: x64
            archive_ext: tar.gz
            binary_name: i18next-turbo
            libc: ""
            allow_failure: false
          - artifact: i18next-turbo-darwin-arm64
            package_name: i18next-turbo-darwin-arm64
            os: darwin
            cpu: arm64
            archive_ext: tar.gz
            binary_name: i18next-turbo
            libc: ""
            allow_failure: false
          - artifact: i18next-turbo-linux-x64-gnu
            package_name: i18next-turbo-linux-x64-gnu
            os: linux
            cpu: x64
            archive_ext: tar.gz
            binary_name: i18next-turbo
            libc: glibc
            allow_failure: false
          - artifact: i18next-turbo-linux-x64-musl
            package_name: i18next-turbo-linux-x64-musl
            os: linux
            cpu: x64
            archive_ext: tar.gz
            binary_name: i18next-turbo
            libc: musl
            allow_failure: false
          - artifact: i18next-turbo-win32-x64-msvc
            package_name: i18next-turbo-win32-x64-msvc
            os: win32
            cpu: x64
            archive_ext: zip
            binary_name: i18next-turbo.exe
            libc: ""
            allow_failure: true
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref }}
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: https://registry.npmjs.org
      - name: Download platform artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist
      - name: Prepare platform package
        env:
          PKG_NAME: ${{ matrix.package_name }}
          PKG_OS: ${{ matrix.os }}
          PKG_CPU: ${{ matrix.cpu }}
          PKG_LIBC: ${{ matrix.libc }}
          BIN_NAME: ${{ matrix.binary_name }}
          ARCHIVE_EXT: ${{ matrix.archive_ext }}
        run: |
          set -euo pipefail
          ARCHIVE_PATH="$(find dist -type f -name "*.${ARCHIVE_EXT}" | head -n 1)"
          if [ -z "${ARCHIVE_PATH}" ]; then
            echo "Archive not found for ${PKG_NAME} (*.${ARCHIVE_EXT})"
            exit 1
          fi

          rm -rf platform-package
          mkdir -p platform-package

          if [ "${ARCHIVE_EXT}" = "zip" ]; then
            unzip -q "${ARCHIVE_PATH}" -d platform-package
          else
            tar -xzf "${ARCHIVE_PATH}" -C platform-package
          fi

          node - <<'NODE'
          const fs = require('fs');
          const rootPkg = require('./package.json');
          const repositoryUrl = (
            (typeof rootPkg.repository === 'string'
              ? rootPkg.repository
              : rootPkg.repository?.url) || 'https://github.com/albert-einshutoin/i18next-turbo'
          ).replace(/\.git$/, '');
          const pkg = {
            name: process.env.PKG_NAME,
            version: rootPkg.version,
            description: `Prebuilt binary for ${process.env.PKG_NAME}`,
            license: "MIT",
            repository: {
              type: "git",
              url: repositoryUrl
            },
            homepage: rootPkg.homepage,
            bugs: rootPkg.bugs,
            os: [process.env.PKG_OS],
            cpu: [process.env.PKG_CPU],
            files: [process.env.BIN_NAME]
          };
          if (process.env.PKG_LIBC) {
            pkg.libc = [process.env.PKG_LIBC];
          }
          fs.writeFileSync('platform-package/package.json', `${JSON.stringify(pkg, null, 2)}\n`);
          NODE
      - name: Check if platform package version is already published
        id: npm_platform_version
        env:
          PKG_NAME: ${{ matrix.package_name }}
        run: |
          VERSION="$(node -p "require('./package.json').version")"
          if npm view "${PKG_NAME}@${VERSION}" version >/dev/null 2>&1; then
            echo "already_published=true" >> "$GITHUB_OUTPUT"
            echo "${PKG_NAME}@${VERSION} is already published. Skipping publish."
          else
            echo "already_published=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Publish platform package
        if: steps.npm_platform_version.outputs.already_published != 'true'
        run: npm publish ./platform-package --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-npm:
    runs-on: ubuntu-latest
    needs: [build, release, publish-platform-npm]
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref }}
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: https://registry.npmjs.org
      - name: Sync package version from Cargo.toml
        run: npm run sync-version
      - name: Check if version is already published
        id: npm_version
        run: |
          VERSION="$(node -p "require('./package.json').version")"
          if npm view "i18next-turbo@${VERSION}" version >/dev/null 2>&1; then
            echo "already_published=true" >> "$GITHUB_OUTPUT"
            echo "i18next-turbo@${VERSION} is already published. Skipping publish."
          else
            echo "already_published=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Publish package
        if: steps.npm_version.outputs.already_published != 'true'
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
